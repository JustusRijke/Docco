name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ["3.11", "3.x"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext imagemagick poppler-utils

      - name: Install Python dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest --cov=src/docco --cov-report=term-missing --cov-report=xml

      - name: Upload test output on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: test-output-ubuntu-py${{ matrix.python-version }}
          path: tests/output/
          retention-days: 7

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  test-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.x"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          choco install imagemagick --version=6.9.11.62 --force -y

      - name: Download and install Poppler
        shell: pwsh
        run: |
          $url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v21.11.0-0/Release-21.11.0-0.zip"
          $outfile = "poppler.zip"
          Invoke-WebRequest -Uri $url -OutFile $outfile
          Expand-Archive -Path $outfile -DestinationPath "."
          $binpath = "$PWD\poppler-21.11.0\Library\bin"
          echo "$binpath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added Poppler to PATH: $binpath"

          # Verify pdftocairo is available
          $env:PATH = "$binpath;$env:PATH"
          $pdftocairo = Get-Command pdftocairo -ErrorAction SilentlyContinue
          if (-not $pdftocairo) {
            throw "pdftocairo not found after installation"
          }
          Write-Host "Verified: pdftocairo found at $($pdftocairo.Source)"

      - name: Download and install gettext
        shell: pwsh
        run: |
          $url = "https://github.com/mlocati/gettext-iconv-windows/releases/download/v0.21-v1.16/gettext0.21-iconv1.16-static-64.zip"
          $outfile = "gettext.zip"
          Invoke-WebRequest -Uri $url -OutFile $outfile
          Expand-Archive -Path $outfile -DestinationPath "gettext"
          $binpath = "$PWD\gettext\bin"
          echo "$binpath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added gettext to PATH: $binpath"

          # Verify msginit is available
          $env:PATH = "$binpath;$env:PATH"
          $msginit = Get-Command msginit -ErrorAction SilentlyContinue
          if (-not $msginit) {
            throw "msginit not found after installation"
          }
          Write-Host "Verified: msginit found at $($msginit.Source)"

      - name: Download and extract WeasyPrint executable
        shell: pwsh
        run: |
          $url = "https://github.com/Kozea/WeasyPrint/releases/download/v67.0/weasyprint-windows.zip"
          $outfile = "weasyprint.zip"
          Invoke-WebRequest -Uri $url -OutFile $outfile
          Expand-Archive -Path $outfile -DestinationPath "weasyprint"
          $binpath = "$PWD\weasyprint\dist"
          echo "$binpath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added WeasyPrint to PATH: $binpath"

          # Verify weasyprint is available
          $env:PATH = "$binpath;$env:PATH"
          $weasyprint = Get-Command weasyprint -ErrorAction SilentlyContinue
          if (-not $weasyprint) {
            throw "weasyprint not found after installation"
          }
          Write-Host "Verified: weasyprint found at $($weasyprint.Source)"

      - name: Install Python dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest --cov=src/docco --cov-report=term-missing --cov-report=xml

      - name: Upload test output on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: test-output-windows-py${{ matrix.python-version }}
          path: tests/output/
          retention-days: 7
